# =========================================================
# Nome do workflow (aparece na aba "Actions" do GitHub)
# =========================================================
name: Deploy autom√°tico no Cloud Run

# =========================================================
# üî¥ WORKFLOW DESATIVADO TEMPORARIAMENTE
#
# Motivo:
# - Evitar deploy autom√°tico
# - Evitar custos
# - Projeto em fase inicial / estudo
#
# ‚úÖ COMO ATIVAR NO FUTURO:
# 1) Substitua a linha:
#      on: []
#
#    por:
#      on:
#        push:
#          branches:
#            - main
#
# 2) Salve o arquivo e fa√ßa um commit.
# 3) O deploy autom√°tico volta a funcionar.
#
# ‚ö†Ô∏è Enquanto `on: []` estiver aqui, ESTE WORKFLOW N√ÉO RODA.
# =========================================================
on: []

jobs:
  deploy:
    # M√°quina virtual usada pelo GitHub Actions
    runs-on: ubuntu-latest

    # Permiss√µes m√≠nimas necess√°rias
    permissions:
      contents: read
      id-token: write  # Necess√°rio para Workload Identity Federation (sem chave)

    # Vari√°veis de ambiente do projeto
    env:
      PROJECT_ID: eastern-entity-386902
      REGION: southamerica-east1
      SERVICE_NAME: alimentacao-e-exercicio
      REPOSITORY: cloud-run
      IMAGE_NAME: app

    steps:
      # -----------------------------------------------------
      # PASSO 1 ‚Äî Baixar o c√≥digo do reposit√≥rio
      # -----------------------------------------------------
      - name: Checkout do c√≥digo
        uses: actions/checkout@v4

      # -----------------------------------------------------
      # PASSO 2 ‚Äî Autentica√ß√£o no Google Cloud
      # (SEM chave privada, usando Workload Identity Federation)
      # -----------------------------------------------------
      - name: Autentica√ß√£o no Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/158473325797/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions-deploy@eastern-entity-386902.iam.gserviceaccount.com

      # -----------------------------------------------------
      # PASSO 3 ‚Äî Configurar o gcloud
      # -----------------------------------------------------
      - name: Configurar gcloud
        uses: google-github-actions/setup-gcloud@v2

      # -----------------------------------------------------
      # PASSO 4 ‚Äî Autenticar Docker no Artifact Registry
      # -----------------------------------------------------
      - name: Autenticar Docker
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # -----------------------------------------------------
      # PASSO 5 ‚Äî Build da imagem Docker
      # -----------------------------------------------------
      - name: Build da imagem Docker
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest .

      # -----------------------------------------------------
      # PASSO 6 ‚Äî Enviar imagem para o Artifact Registry
      # -----------------------------------------------------
      - name: Push da imagem para o Artifact Registry
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest

      # -----------------------------------------------------
      # PASSO 7 ‚Äî Deploy no Cloud Run
      # (S√≥ executa quando o workflow estiver ATIVADO)
      # -----------------------------------------------------
      - name: Deploy no Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/${{ env.IMAGE_NAME }}:latest \
            --region ${{ env.REGION }} \
            --platform managed \
            --allow-unauthenticated
